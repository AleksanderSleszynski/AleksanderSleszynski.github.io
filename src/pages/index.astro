---
import TerminalLayout from '../layouts/TerminalLayout.astro';
import resumeEn from '../data/resume.json';
import resumePl from '../data/resume_pl.json';
import projectsEn from '../data/projects.json';
import projectsPl from '../data/projects_pl.json';
import { ui, icons, services } from '../data/siteConfig';

// --- TYPE DEFINITIONS ---
interface Award { title: string; issuer: string; date: string; }
interface Certificate { name: string; issuer: string; date: string; }
interface Education { institution: string; area: string; startDate: string; endDate: string; }
interface ResumeData { awards?: Award[]; certificates?: Certificate[]; education?: Education[]; [key: string]: any; }

// --- DATA LOGIC ---
const getSortedAchievements = (data: ResumeData) => {
    const awards = (data.awards || []).map((a: Award) => ({ ...a, type: 'award', displayTitle: a.title }));
    const certs = (data.certificates || []).map((c: Certificate) => ({ ...c, type: 'cert', displayTitle: c.name }));
    return [...awards, ...certs].sort((a, b) => {
        // Extract year from date strings (e.g. "Feb 2024" -> 2024)
        const getYear = (d: string) => {
            const match = d.match(/\d{4}/);
            return match ? parseInt(match[0]) : 0;
        };
        return getYear(b.date) - getYear(a.date);
    });
};

const sortedAchievementsEn = getSortedAchievements(resumeEn);
const sortedAchievementsPl = getSortedAchievements(resumePl);
---

<TerminalLayout title={`${resumeEn.basics.name} - DevOps Engineer`} description={resumeEn.basics.summary}>
    
    <!-- Header Section -->
    <header class="mb-12 border-b border-gray-800 pb-8 relative">
        <div class="lang-en">
            <h1 class="text-5xl font-bold text-gray-100 mb-2 text-glow">{resumeEn.basics.name}</h1>
            <h2 class="text-2xl text-gray-400 mb-6">{resumeEn.basics.label}</h2>
            <p class="text-gray-400 max-w-2xl text-sm italic mb-6 border-l-2 border-gray-700 pl-4">{resumeEn.basics.summary}</p>
        </div>
        <div class="lang-pl hidden">
            <h1 class="text-5xl font-bold text-gray-100 mb-2 text-glow">{resumePl.basics.name}</h1>
            <h2 class="text-2xl text-gray-400 mb-6">{resumePl.basics.label}</h2>
            <p class="text-gray-400 max-w-2xl text-sm italic mb-6 border-l-2 border-gray-700 pl-4">{resumePl.basics.summary}</p>
        </div>

        <div class="flex flex-wrap gap-6 text-sm text-gray-400 mt-6 print:text-black">
            <div class="flex items-center gap-2 hover:text-green-400 transition-colors">
                <span class="lang-en">üìç {resumeEn.basics.location}</span>
                <span class="lang-pl hidden">üìç {resumePl.basics.location}</span>
            </div>
            {resumeEn.basics.github && (
                <a href={`https://github.com/${resumeEn.basics.github}`} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:text-green-400 transition-colors">
                    <span class="w-5 h-5" set:html={icons.github} />
                    GitHub
                </a>
            )}
            {resumeEn.basics.linkedin && (
                <a href={resumeEn.basics.linkedin} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 hover:text-green-400 transition-colors">
                    <span class="w-5 h-5" set:html={icons.linkedin} />
                    LinkedIn
                </a>
            )}
        </div>
    </header>

    <!-- Skills Section -->
    <section class="mb-12 break-inside-avoid">
        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.skills_header.en}</span>
            <span class="lang-pl hidden">{ui.skills_header.pl}</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <span class="text-purple-400 text-sm block mb-2">> 
                    <span class="lang-en">{ui.backend_scan.en}</span>
                    <span class="lang-pl hidden">{ui.backend_scan.pl}</span>
                </span>
                <div class="flex flex-wrap gap-2 lang-en">
                    {resumeEn.skills.backend.map((skill: string) => (
                        <span class="bg-gray-800 text-gray-300 px-2 py-1 text-xs rounded hover:bg-green-900 hover:text-white transition-colors cursor-default border border-gray-700">{skill}</span>
                    ))}
                </div>
                <div class="flex flex-wrap gap-2 lang-pl hidden">
                    {resumePl.skills.backend.map((skill: string) => (
                        <span class="bg-gray-800 text-gray-300 px-2 py-1 text-xs rounded hover:bg-green-900 hover:text-white transition-colors cursor-default border border-gray-700">{skill}</span>
                    ))}
                </div>
            </div>
            <div>
                <span class="text-purple-400 text-sm block mb-2">> 
                    <span class="lang-en">{ui.devops_scan.en}</span>
                    <span class="lang-pl hidden">{ui.devops_scan.pl}</span>
                </span>
                <div class="flex flex-wrap gap-2 lang-en">
                    {resumeEn.skills.devops.map((skill: string) => (
                        <span class="bg-gray-800 text-gray-300 px-2 py-1 text-xs rounded hover:bg-green-900 hover:text-white transition-colors cursor-default border border-gray-700">{skill}</span>
                    ))}
                </div>
                <div class="flex flex-wrap gap-2 lang-pl hidden">
                    {resumePl.skills.devops.map((skill: string) => (
                        <span class="bg-gray-800 text-gray-300 px-2 py-1 text-xs rounded hover:bg-green-900 hover:text-white transition-colors cursor-default border border-gray-700">{skill}</span>
                    ))}
                </div>
            </div>
        </div>
    </section>

    <!-- Experience Section -->
    <section class="mb-12">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.experience_header.en}</span>
            <span class="lang-pl hidden">{ui.experience_header.pl}</span>
        </h3>
        
        <div class="space-y-8 lang-en">
            {resumeEn.work.map((job: any) => (
                <div class="relative pl-6 border-l border-gray-700 hover:border-green-500 transition-colors duration-300 break-inside-avoid">
                    <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 bg-gray-700 rounded-full"></div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-baseline mb-2">
                        <h4 class="text-lg font-bold text-gray-100">{job.position}</h4>
                        <span class="text-sm text-gray-500 font-bold">{job.startDate} ‚Äî {job.endDate}</span>
                    </div>
                    <div class="text-purple-400 text-sm mb-2">@ {job.company}</div>
                    <ul class="list-none space-y-1">
                        {job.highlights.map((item: string) => <li class="text-gray-400 text-sm flex items-start"><span class="mr-2 text-green-500 opacity-50">></span>{item}</li>)}
                    </ul>
                </div>
            ))}
        </div>

        <div class="space-y-8 lang-pl hidden">
            {resumePl.work.map((job: any) => (
                <div class="relative pl-6 border-l border-gray-700 hover:border-green-500 transition-colors duration-300 break-inside-avoid">
                    <div class="absolute -left-[5px] top-0 w-2.5 h-2.5 bg-gray-700 rounded-full"></div>
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-baseline mb-2">
                        <h4 class="text-lg font-bold text-gray-100">{job.position}</h4>
                        <span class="text-sm text-gray-500 font-bold">{job.startDate} ‚Äî {job.endDate}</span>
                    </div>
                    <div class="text-purple-400 text-sm mb-2">@ {job.company}</div>
                    <ul class="list-none space-y-1">
                        {job.highlights.map((item: string) => <li class="text-gray-400 text-sm flex items-start"><span class="mr-2 text-green-500 opacity-50">></span>{item}</li>)}
                    </ul>
                </div>
            ))}
        </div>
    </section>

    <!-- Education Section -->
    <section class="mb-12 break-inside-avoid">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.education_header.en}</span>
            <span class="lang-pl hidden">{ui.education_header.pl}</span>
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- EN -->
            <div class="lang-en contents">
                {resumeEn.education?.map((edu: Education) => (
                    <div class="border border-gray-800 bg-gray-900/20 p-4 rounded hover:border-blue-500/50 transition-colors group">
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-blue-400 group-hover:text-blue-300" set:html={icons.university} />
                            <!-- FIX: Replaced lbl_degree with lbl_field to match siteConfig.ts -->
                            <span class="text-xs text-gray-600 border border-gray-800 px-1 rounded">{ui.lbl_field.en}</span>
                        </div>
                        <h4 class="font-bold text-gray-200 text-sm mb-1">{edu.area}</h4>
                        <div class="text-xs text-purple-400 mb-1">{edu.institution}</div>
                        <div class="text-xs text-gray-500 font-mono">{edu.startDate} - {edu.endDate}</div>
                    </div>
                ))}
            </div>
            <!-- PL -->
            <div class="lang-pl contents hidden">
                {resumePl.education?.map((edu: Education) => (
                    <div class="border border-gray-800 bg-gray-900/20 p-4 rounded hover:border-blue-500/50 transition-colors group">
                        <div class="flex items-start justify-between mb-2">
                            <span class="text-blue-400 group-hover:text-blue-300" set:html={icons.university} />
                            <!-- FIX: Replaced lbl_degree with lbl_field to match siteConfig.ts -->
                            <span class="text-xs text-gray-600 border border-gray-800 px-1 rounded">{ui.lbl_field.pl}</span>
                        </div>
                        <h4 class="font-bold text-gray-200 text-sm mb-1">{edu.area}</h4>
                        <div class="text-xs text-purple-400 mb-1">{edu.institution}</div>
                        <div class="text-xs text-gray-500 font-mono">{edu.startDate} - {edu.endDate}</div>
                    </div>
                ))}
            </div>
        </div>
    </section>

    <!-- Achievements Section -->
    <section class="mb-12 break-inside-avoid">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.achievements_header.en}</span>
            <span class="lang-pl hidden">{ui.achievements_header.pl}</span>
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- EN -->
            <div class="lang-en contents">
                {sortedAchievementsEn.map((item) => (
                    <div class={`border p-4 rounded transition-colors group ${item.type === 'award' ? 'border-yellow-900/40 bg-yellow-900/10 hover:border-yellow-500/50' : 'border-gray-800 bg-gray-900/20 hover:border-green-500/50'}`}>
                        <div class="flex items-start justify-between mb-2">
                            <span class={`${item.type === 'award' ? 'text-yellow-500 group-hover:text-yellow-300' : 'text-green-400 group-hover:text-green-300'}`} set:html={item.type === 'award' ? icons.trophy : icons.cert} />
                            <span class={`text-xs border px-1 rounded ${item.type === 'award' ? 'text-yellow-600/80 border-yellow-900/50' : 'text-gray-600 border-gray-800'}`}>
                                {item.type === 'award' ? ui.lbl_award.en : ui.lbl_cert.en}
                            </span>
                        </div>
                        <h4 class="font-bold text-gray-200 text-sm mb-1">{item.displayTitle}</h4>
                        <div class="flex justify-between text-xs text-gray-500 font-mono mt-2">
                            <span>{item.issuer}</span>
                            <span>{item.date}</span>
                        </div>
                    </div>
                ))}
            </div>

            <!-- PL -->
            <div class="lang-pl contents hidden">
                {sortedAchievementsPl.map((item) => (
                    <div class={`border p-4 rounded transition-colors group ${item.type === 'award' ? 'border-yellow-900/40 bg-yellow-900/10 hover:border-yellow-500/50' : 'border-gray-800 bg-gray-900/20 hover:border-green-500/50'}`}>
                        <div class="flex items-start justify-between mb-2">
                            <span class={`${item.type === 'award' ? 'text-yellow-500 group-hover:text-yellow-300' : 'text-green-400 group-hover:text-green-300'}`} set:html={item.type === 'award' ? icons.trophy : icons.cert} />
                            <span class={`text-xs border px-1 rounded ${item.type === 'award' ? 'text-yellow-600/80 border-yellow-900/50' : 'text-gray-600 border-gray-800'}`}>
                                {item.type === 'award' ? ui.lbl_award.pl : ui.lbl_cert.pl}
                            </span>
                        </div>
                        <h4 class="font-bold text-gray-200 text-sm mb-1">{item.displayTitle}</h4>
                        <div class="flex justify-between text-xs text-gray-500 font-mono mt-2">
                            <span>{item.issuer}</span>
                            <span>{item.date}</span>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </section>

    <!-- NEW: PROJECTS ARCHIVE -->
    <section class="mb-12 break-inside-avoid">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.projects_header.en}</span>
            <span class="lang-pl hidden">{ui.projects_header.pl}</span>
        </h3>

        <!-- EN Projects -->
        <div class="grid grid-cols-1 gap-4 lang-en">
            {projectsEn.map((project) => (
                <div class="border border-gray-800 bg-gray-900/10 p-6 rounded hover:bg-gray-800/20 transition-colors group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition-opacity">
                        <span class="text-gray-500" set:html={icons.file} />
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-gray-100 text-lg mb-1">{project.title}</h4>
                            <div class="text-xs text-purple-400 font-mono mb-2">> Role: {project.role}</div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4 leading-relaxed">{project.summary}</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        {project.tech.map(t => <span class="text-xs bg-gray-800 text-gray-300 px-2 py-0.5 rounded">{t}</span>)}
                    </div>
                    <button 
                        class="text-xs text-green-400 hover:text-green-300 font-bold flex items-center gap-2 project-trigger"
                        data-id={`en-${project.id}`}
                    >
                        {ui.lbl_read_more.en} <span class="animate-pulse">_</span>
                    </button>
                    
                    <!-- Hidden Content for Modal -->
                    <div id={`content-en-${project.id}`} class="hidden">
                        {project.content}
                    </div>
                </div>
            ))}
        </div>

        <!-- PL Projects -->
        <div class="grid grid-cols-1 gap-4 lang-pl hidden">
            {projectsPl.map((project) => (
                <div class="border border-gray-800 bg-gray-900/10 p-6 rounded hover:bg-gray-800/20 transition-colors group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-2 opacity-20 group-hover:opacity-40 transition-opacity">
                        <span class="text-gray-500" set:html={icons.file} />
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-gray-100 text-lg mb-1">{project.title}</h4>
                            <div class="text-xs text-purple-400 font-mono mb-2">> Rola: {project.role}</div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mb-4 leading-relaxed">{project.summary}</p>
                    <div class="flex flex-wrap gap-2 mb-4">
                        {project.tech.map(t => <span class="text-xs bg-gray-800 text-gray-300 px-2 py-0.5 rounded">{t}</span>)}
                    </div>
                    <button 
                        class="text-xs text-green-400 hover:text-green-300 font-bold flex items-center gap-2 project-trigger"
                        data-id={`pl-${project.id}`}
                    >
                        {ui.lbl_read_more.pl} <span class="animate-pulse">_</span>
                    </button>

                    <!-- Hidden Content for Modal -->
                    <div id={`content-pl-${project.id}`} class="hidden">
                        {project.content}
                    </div>
                </div>
            ))}
        </div>
    </section>

    <!-- Services Section -->
    <section class="mb-12 break-inside-avoid print:hidden">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.services_header.en}</span>
            <span class="lang-pl hidden">{ui.services_header.pl}</span>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {services.map((service) => (
                <div class="border border-gray-800 bg-gray-900/10 p-4 rounded hover:bg-gray-800/30 hover:border-blue-500/50 transition-all group">
                    <div class="mb-3 text-blue-400 group-hover:text-blue-300" set:html={service.icon} />
                    <h4 class="font-bold text-gray-200 text-sm mb-2">
                        <span class="lang-en">{service.title.en}</span>
                        <span class="lang-pl hidden">{service.title.pl}</span>
                    </h4>
                    <p class="text-xs text-gray-500 leading-relaxed">
                        <span class="lang-en">{service.desc.en}</span>
                        <span class="lang-pl hidden">{service.desc.pl}</span>
                    </p>
                </div>
            ))}
        </div>
    </section>

    <!-- Contact Section -->
    <section class="mb-12 break-inside-avoid print:hidden">
        <h3 class="text-xl font-bold text-white mb-6 border-b border-gray-800 inline-block text-glow">
            <span class="lang-en">{ui.contact_header.en}</span>
            <span class="lang-pl hidden">{ui.contact_header.pl}</span>
        </h3>
        
        <div class="border border-gray-700 p-8 rounded bg-gray-900/30 hover:border-green-500 transition-colors text-center">
            <div class="text-purple-400 text-sm mb-4 font-bold">> 
                <span class="lang-en">{ui.protocol_linkedin.en}</span>
                <span class="lang-pl hidden">{ui.protocol_linkedin.pl}</span>
            </div>
            <p class="text-gray-400 mb-8 max-w-2xl mx-auto text-sm">
                <span class="lang-en">{ui.contact_desc.en}</span>
                <span class="lang-pl hidden">{ui.contact_desc.pl}</span>
            </p>

            {resumeEn.basics.linkedin && (
                <a href={resumeEn.basics.linkedin} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-3 bg-green-900/20 text-green-400 border border-green-800 px-6 py-3 rounded hover:bg-green-500 hover:text-black transition-all font-bold text-base group">
                    <span class="w-5 h-5 group-hover:animate-bounce" set:html={icons.linkedin} />
                    <span class="lang-en">{ui.btn_linkedin.en}</span>
                    <span class="lang-pl hidden">{ui.btn_linkedin.pl}</span>
                </a>
            )}
        </div>
    </section>

    <!-- Footer -->
    <div class="mt-20 pt-6 border-t border-gray-800 text-sm text-gray-600 flex justify-between">
        <span>{ui.footer_eof}</span>
        <span class="animate-pulse">_</span>
    </div>

    <!-- PROJECT MODAL (Hidden by default) -->
    <div id="project-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
        <div class="bg-[#0d1117] border border-green-900 w-full max-w-2xl rounded shadow-2xl flex flex-col max-h-[80vh]">
            <!-- Modal Header -->
            <div class="bg-gray-900 p-3 border-b border-gray-800 flex justify-between items-center">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
                <div class="text-gray-500 text-xs font-mono" id="modal-title-bar">project_log.txt</div>
                <button id="close-modal" class="text-gray-500 hover:text-white">
                    <span class="w-5 h-5" set:html={icons.close} />
                </button>
            </div>
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto font-mono text-sm text-gray-300 leading-relaxed whitespace-pre-wrap" id="modal-body">
                <!-- Content injected via JS -->
            </div>
            <!-- Modal Footer -->
            <div class="p-3 border-t border-gray-800 bg-gray-900/50 text-xs text-gray-600 font-mono flex justify-between">
                <span>MODE: READ-ONLY</span>
                <span class="lang-en">{ui.lbl_close_file.en} [ESC]</span>
                <span class="lang-pl hidden">{ui.lbl_close_file.pl} [ESC]</span>
            </div>
        </div>
    </div>

</TerminalLayout>

<script>
    // MODAL LOGIC
    const modal = document.getElementById('project-modal');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title-bar');
    const closeBtn = document.getElementById('close-modal');
    const triggers = document.querySelectorAll('.project-trigger');

    function openModal(contentId: string, title: string) {
        const contentDiv = document.getElementById(`content-${contentId}`);
        if (contentDiv && modal && modalBody && modalTitle) {
            modalBody.textContent = contentDiv.textContent || '';
            modalTitle.textContent = `${title.toLowerCase().replace(/\s+/g, '_')}.log`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
    }

    function closeModal() {
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = '';
        }
    }

    // Event Listeners
    triggers.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            const id = target.dataset.id;
            // Find title in parent
            const card = target.closest('div');
            const title = card?.querySelector('h4')?.textContent || 'project';
            if (id) openModal(id, title);
        });
    });

    closeBtn?.addEventListener('click', closeModal);
    
    // Close on outside click
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // Close on ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
            closeModal();
        }
    });

    // --- Typewriter Effect ---
    const text = "./show-resume.sh --verbose";
    const element = document.getElementById("typewriter");
    let index = 0;
    function typeWriter() {
        if (element && index < text.length) {
            element.innerHTML += text.charAt(index);
            index++;
            setTimeout(typeWriter, 50); 
        }
    }
    window.onload = typeWriter;

    // --- Language Switcher Logic ---
    const toggleBtn = document.getElementById('lang-toggle');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
            const enElements = document.querySelectorAll('.lang-en');
            const plElements = document.querySelectorAll('.lang-pl');
            enElements.forEach(el => el.classList.toggle('hidden'));
            plElements.forEach(el => el.classList.toggle('hidden'));
        });
    }
</script>