---
// src/components/ProjectModal.astro
import { ui, icons } from '../data/siteConfig';

// Fetch labels from config to pass them to the client-side script
const headers = { 
    problem: { en: ui.proj_problem.en, pl: ui.proj_problem.pl },
    solution: { en: ui.proj_solution.en, pl: ui.proj_solution.pl },
    arch: { en: ui.proj_arch.en, pl: ui.proj_arch.pl },
    result: { en: ui.proj_result.en, pl: ui.proj_result.pl }
};
---

<!-- MODAL MARKUP -->
<div id="project-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-[#0d1117] border border-green-900 w-full max-w-2xl rounded shadow-2xl flex flex-col max-h-[80vh]">
        <!-- Modal Header -->
        <div class="bg-gray-900 p-3 border-b border-gray-800 flex justify-between items-center">
            <div class="flex gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
            <div class="text-gray-500 text-xs font-mono" id="modal-title-bar">project_log.txt</div>
            <button id="close-modal" class="text-gray-500 hover:text-white cursor-pointer">
                <span class="w-5 h-5" set:html={icons.close} />
            </button>
        </div>

        <!-- Modal Content (Dynamic) -->
        <div class="p-6 overflow-y-auto font-mono text-sm text-gray-300 leading-relaxed" id="modal-body"></div>

        <!-- Modal Footer -->
        <div class="p-3 border-t border-gray-800 bg-gray-900/50 text-xs text-gray-600 font-mono flex justify-between">
            <span>MODE: READ-ONLY</span>
            <span class="lang-en">{ui.lbl_close_file.en} [ESC]</span>
            <span class="lang-pl hidden">{ui.lbl_close_file.pl} [ESC]</span>
        </div>
    </div>
</div>

<!-- CLIENT-SIDE SCRIPT -->
<script is:inline define:vars={{ headers }}>
    // MODAL LOGIC
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('project-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title-bar');
        
        // Function to open the modal and populate it with data
        function openModal(contentId, title) {
            const dataScript = document.getElementById(`data-${contentId}`);
            
            if (!dataScript) {
                console.error(`Data not found for element: #data-${contentId}`);
                return;
            }
            if (!modal || !modalBody) return;

            try {
                const project = JSON.parse(dataScript.textContent);
                const lang = contentId.startsWith('en-') ? 'en' : 'pl';
                let html = '';

                // 1. PROBLEM SECTION
                if (project.problem && project.problem.length > 0) {
                    html += `<h5 class="text-purple-400 font-bold text-base mt-2 mb-2 uppercase border-b border-gray-800 pb-1 w-fit">${headers.problem[lang]}</h5>`;
                    project.problem.forEach(text => html += `<p class="mb-2 text-gray-300">${text}</p>`);
                }
                // 2. SOLUTION SECTION
                if (project.solution && project.solution.length > 0) {
                    html += `<h5 class="text-purple-400 font-bold text-base mt-6 mb-2 uppercase border-b border-gray-800 pb-1 w-fit">${headers.solution[lang]}</h5>`;
                    html += `<ul class="space-y-2 mb-4">`;
                    project.solution.forEach(item => {
                        html += `<li class="flex items-start"><span class="text-green-500/70 mr-2 mt-0.5">></span><span>${item}</span></li>`;
                    });
                    html += `</ul>`;
                }
                // 3. ARCHITECTURE SECTION
                if (project.architecture && project.architecture.length > 0) {
                    html += `<h5 class="text-purple-400 font-bold text-base mt-6 mb-2 uppercase border-b border-gray-800 pb-1 w-fit">${headers.arch[lang]}</h5>`;
                    project.architecture.forEach(text => html += `<p class="mb-2 text-gray-300">${text}</p>`);
                }
                // 4. RESULT SECTION
                if (project.result && project.result.length > 0) {
                    html += `<h5 class="text-purple-400 font-bold text-base mt-6 mb-2 uppercase border-b border-gray-800 pb-1 w-fit">${headers.result[lang]}</h5>`;
                    html += `<ul class="space-y-2 mb-4">`;
                    project.result.forEach(item => {
                        html += `<li class="flex items-start"><span class="text-yellow-500/70 mr-2 mt-0.5">âœ”</span><span>${item}</span></li>`;
                    });
                    html += `</ul>`;
                }

                modalBody.innerHTML = html;
                if(modalTitle) modalTitle.textContent = `${title.toLowerCase().replace(/\s+/g, '_')}.log`;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            } catch (e) {
                console.error("JSON Parse Error:", e);
            }
        }

        function closeModal() {
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                document.body.style.overflow = ''; // Restore background scrolling
            }
        }

        // GLOBAL CLICK LISTENER (Event Delegation)
        document.addEventListener('click', (e) => {
            // Handle "Read Log" buttons
            const triggerBtn = e.target.closest('.project-trigger');
            if (triggerBtn) {
                e.preventDefault(); 
                const id = triggerBtn.dataset.id;
                const card = triggerBtn.closest('.group'); 
                const titleElement = card ? card.querySelector('h4') : null;
                const title = titleElement ? titleElement.textContent : 'project'; 
                
                if (id) openModal(id, title);
                return;
            }
            // Handle Close button
            const closeBtn = e.target.closest('#close-modal');
            if (closeBtn) {
                closeModal();
                return;
            }
            // Handle Click Outside
            if (e.target === modal) {
                closeModal();
            }
        });

        // Handle ESC Key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
        });
    });
</script>